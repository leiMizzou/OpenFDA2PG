# OpenFDA Data to PostgreSQL Database Import Tool

This project provides tools to download data from the OpenFDA API and import it into a PostgreSQL database. It is intended for GitHub users and researchers who want to analyze OpenFDA data using SQL.

## Project Structure

```
OpenFDA2PG/
├── config.py             # Database connection configuration
├── data_check.py         # Data analysis and exploration scripts (Jupyter Notebook converted to .py)
├── data_validator.py     # Data validation after import
├── file_handler.py       # File handling utilities
├── file-structure.txt    # (Description of expected file structure - likely obsolete)
├── json_download.py      # Script to download data from OpenFDA
├── json_pgsql_validator.py # (Another validator script, possibly for JSON schema validation)
├── json_sampling.py      # Script for sampling JSON data
├── logger.py             # Logging utilities
├── main.py               # Main program entry point
├── requirements.txt      # Python dependencies
├── schema_creator.py     # Creates the database schema
├── utils.py              # General utility functions
├── validation_report.txt # (Validation report - likely generated by data_validator.py)
├── validation_report.xlsx# (Excel version of validation report)
└── importers/            # Importers for specific data categories
    ├── __init__.py
    ├── adverse_event_importer.py
    ├── base_importer.py
    ├── classification_importer.py
    ├── enforcement_importer.py
    ├── recall_importer.py
    └── udi_importer.py
```

*   **config.py**: Contains database connection settings.
*   **data\_check.py**: Contains scripts for data analysis (converted from a Jupyter Notebook).
*   **data\_validator.py**: Performs data validation after the import process.
*   **file\_handler.py**: Provides utility functions for file handling.
*   **json\_download.py**: Downloads data from the OpenFDA API.
*   **json\_pgsql\_validator.py**: Validates JSON data against the PostgreSQL schema.
*   **json\_sampling.py**: Samples JSON data for previewing.
*   **logger.py**: Provides logging functionality.
*   **main.py**: The main script that orchestrates the data download, import, and validation process.
*   **schema\_creator.py**: Creates the necessary database schema.
*   **utils.py**: Contains general utility functions.
*   **json_sampling.py**: Extracts sample data from downloaded JSON files to create smaller representative datasets for previewing and testing.
*   **json_pgsql_validator.py**: Validates the consistency between the imported data in the PostgreSQL database and the original JSON source files.
*  **importers/**: This directory contains importer classes for each specific data category (adverse events, classifications, recalls, etc.).

## Data Source

The data is sourced from [OpenFDA](https://open.fda.gov/), a project by the U.S. Food and Drug Administration (FDA) that provides open data APIs for various FDA datasets, including drugs, devices, and food.

## Installation and Setup

### Prerequisites

*   Python 3.7+
*   PostgreSQL database
*   Python packages listed in `requirements.txt`

### Installation Steps

1.  **Clone the repository:**

    ```bash
    git clone https://github.com/your-username/OpenFDA2PG.git  # Replace with your repository URL
    cd OpenFDA2PG
    ```

2.  **Install the required Python packages:**

    ```bash
    pip install -r requirements.txt
    ```

3.  **Configure the database connection:**

    *   Edit the `config.py` file and update the `DB_CONFIG` dictionary with your PostgreSQL database credentials:

        ```python
        DB_CONFIG = {
            'user': 'your_db_user',
            'password': 'your_db_password',
            'host': 'your_db_host',
            'port': 'your_db_port',
            'database': 'your_db_name'
        }
        ```
     *   Also configure `DATA_DIRS` in `config.py` to specify where data files will be stored.

## Usage

### Downloading Data

Use the `json_download.py` script to download data from OpenFDA. You need to specify the target category as a command-line argument.

**Usage:**

```bash
python json_download.py <main_category>/<sub_category> [filter_string]
```

*   **`<main_category>`**: The main category of data (e.g., `device`, `food`, `drug`).
*   **`<sub_category>`**:  The sub-category within the main category (e.g., `udi`, `enforcement`, `event`).
*   **`[filter_string]`** (optional): A string to filter the downloaded partitions based on their `display_name`.

**Examples:**

*   Download device UDI data:

    ```bash
    python json_download.py device/udi
    ```

*   Download food enforcement reports for the year 2024:

    ```bash
    python json_download.py food/enforcement 2024
    ```
*   Download device event data:
    ```bash
    python json_download.py device/event
    ```

The script will download the data files and store them in the `datafiles` directory (or the directory you configured in `config.py`).

### Importing Data

Use the `main.py` script to import the downloaded data into the PostgreSQL database.  This script handles schema creation, data import, and validation.

**Usage:**
The script will display file statistics, metadata, and sample data before prompting you to continue with the import.

```bash
python main.py
```

The script will:

1.  Create the database schema (if it doesn't exist).
2.  Import data from the downloaded files into the corresponding tables.
3.  Validate the imported data.
### JSON Sampling

The `json_sampling.py` script is used to create smaller sample datasets from the downloaded JSON files. This is useful for:

*   **Previewing data:** Quickly examine the structure and content of the data without loading the entire dataset.
*   **Testing:** Use the sample data for testing import scripts and database queries without waiting for the full import to complete.
*   **Development:** Develop and debug code using a smaller, more manageable dataset.

**Usage:**

```bash
python json_sampling.py <category>
```

*   **`<category>`**: The main category of data to sample (e.g., `device`, `food`, `drug`).  This should be the same as the main category used for downloading.

**Example:**

To create sample files for the `device` category:

```bash
python json_sampling.py device
```

The script will:

1.  Traverse the `datafiles/unzip/<category>` directory.
2.  Extract a small number of records (default is 3) from each JSON file.
3.  Create new JSON files containing only the sampled data in the `datafiles/samples/<category>` directory. The original directory structure *within* each category is flattened, and files are named with a `_sample` suffix.

**Expected Output:**

The script will print messages to the console indicating its progress, including which files are being processed and where the sample files are being saved.  New JSON files will be created in the `datafiles/samples/<category>` directory.

### JSON to PostgreSQL Validation

The `json_pgsql_validator.py` script validates the consistency between the data imported into the PostgreSQL database and the original JSON source files. This helps ensure that the import process was successful and that no data was lost or corrupted.

**Usage:**

```bash
python json_pgsql_validator.py [options]
```

**Options:**

*   `--sample-size <number>`:  The minimum number of records to sample from each data type (default: 10).
*   `--sample-ratio <ratio>`: The percentage of records to sample (e.g., 0.01 for 1%) (default: 0.01).
*   `--output <file>`: The output file for the validation report (default: `./validation_report.txt`).
*   `--host <host>`: Database host (default: from `config.py`).
*   `--port <port>`: Database port (default: from `config.py`).
*   `--dbname <dbname>`: Database name (default: from `config.py`).
*   `--user <user>`: Database user (default: from `config.py`).
*   `--password <password>`: Database password (default: from `config.py`).
*   `--data-dir <directory>`: Base directory for JSON files (default: `../datafiles/unzip/device`).
*   `--type <data_type>`: Only validate a specific data type (`classification`, `enforcement`, `recall`, `adverse_event`, `udi`).

**Example:**

To validate all data types with default settings:

```bash
python json_pgsql_validator.py
```

To validate only the `device` classification data, sampling at least 20 records:

```bash
python json_pgsql_validator.py --type classification --sample-size 20
```

**Expected Output:**

The script will:

1.  Connect to the PostgreSQL database.
2.  Sample records from the JSON files and the corresponding database tables.
3.  Compare the sampled records field by field.
4.  Generate a report summarizing the validation results, including:
    *   Total records in the database table.
    *   Number of records sampled.
    *   Number of records that matched between JSON and database.
    *   Number of records that mismatched.
    *   Details of any mismatches found (field, JSON value, database value).
5.  Print the report to the console and save it to the specified output file (default: `validation_report.txt`). An Excel version (`validation_report.xlsx`) is also created.

If mismatches are found, the report will highlight them, allowing you to investigate potential data integrity issues.

## Data Validation

The `data_validator.py` script is used to validate the imported data. The `main.py` script automatically runs the validation after the import process.

## Example Queries

Here are some example SQL queries you can use to analyze the imported data:

1.  Query all Class 3 high-risk devices:

    ```sql
    SELECT * FROM device.product_codes WHERE device_class = '3';
    ```

2.  Query the trend of adverse events over the past year:

    ```sql
    SELECT date_trunc('month', date_received) as month, COUNT(*)
    FROM device.adverse_events
    WHERE date_received > CURRENT_DATE - INTERVAL '1 year'
    GROUP BY month
    ORDER BY month;
    ```

3.  Query recall classification statistics:

    ```sql
    SELECT classification, COUNT(*)
    FROM device.device_recalls
    GROUP BY classification
    ORDER BY COUNT(*) DESC;
    ```
4.  Query devices for a specific medical specialty:
    ```sql
    SELECT pc.*
    FROM device.product_codes pc
    JOIN device.medical_specialties ms ON pc.medical_specialty_id = ms.id
    WHERE ms.code = 'CV';
    ```
5. Query all records related to a specific product code:
    ```sql
    SELECT 'classification' as type, dc.id
    FROM device.device_classifications dc
    WHERE dc.product_code = 'XXX'  -- Replace XXX with the actual product code
    UNION ALL
    SELECT 'recall' as type, dr.id
    FROM device.device_recalls dr
    WHERE dr.product_code = 'XXX'; -- Replace XXX with the actual product code

    ```

## License

[MIT License](LICENSE)